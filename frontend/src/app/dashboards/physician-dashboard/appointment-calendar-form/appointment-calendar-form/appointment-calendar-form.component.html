<div class="appointment-container">
  <form (ngSubmit)="submit()" class="appointment-form">
    <h2>Agendar Cita para Paciente</h2>

    <!-- Informaci√≥n del m√©dico -->
    <div class="physician-info" *ngIf="currentUser">
      <p><strong>M√©dico:</strong> {{ getPhysicianInfo() }}</p>
      <p><strong>Especialidad:</strong> {{ currentUser.specialty || 'No especificada' }}</p>
      <p><strong>ID:</strong> {{ physicianId }}</p>
    </div>

    <!-- B√∫squeda y selecci√≥n de paciente -->
    <div class="form-group">
      <label for="searchPatient">Buscar Paciente:</label>
      <input 
        type="text" 
        [(ngModel)]="searchPatient" 
        name="searchPatient" 
        id="searchPatient"
        placeholder="Buscar por nombre o RUT..."
        (input)="onPatientSearch()">
    </div>

    <div class="form-group">
      <label for="patient">Paciente *:</label>
      <select 
        [(ngModel)]="newAppt.patient_id" 
        name="patient_id" 
        id="patient" 
        required>
        <option value="">Seleccione un paciente</option>
        <option *ngFor="let patient of filteredPatients" [value]="patient.id">
          {{ patient.fullName }} - {{ patient.rut }}
        </option>
      </select>
      
      <small class="form-help" *ngIf="filteredPatients.length === 0 && searchPatient">
        No se encontraron pacientes con ese criterio
      </small>
    </div>

    <div class="form-group">
      <label for="date">Fecha *:</label>
      <input type="date" [(ngModel)]="newAppt.date" name="date" id="date" required>
    </div>

    <div class="form-group">
      <label for="time">Hora *:</label>
      <input type="time" [(ngModel)]="newAppt.time" name="time" id="time" required>
    </div>

    <div class="form-group">
      <label for="reason">Motivo de la Consulta:</label>
      <textarea 
        [(ngModel)]="newAppt.reason" 
        name="reason" 
        id="reason"
        placeholder="Motivo de la consulta (opcional)"
        rows="3"></textarea>
    </div>

    <div class="form-buttons">
      <button type="submit">Agendar Cita</button>
      <button type="button" (click)="goToPhysicianDashboard()">Volver</button>
      <button type="button" (click)="loadAppointments()" style="background: #28a745;">üîÑ Recargar</button>
    </div>
  </form>

  <div class="calendar-container">
    <h2>Mi Agenda M√©dica</h2>

    <div class="calendar-header">
      <button (click)="previousMonth()" class="nav-btn">‚ùÆ</button>
      <h3>{{ getMonthName() }}</h3>
      <button (click)="nextMonth()" class="nav-btn">‚ùØ</button>
    </div>

    <div class="calendar-grid">
      <div class="calendar-day-header">Dom</div>
      <div class="calendar-day-header">Lun</div>
      <div class="calendar-day-header">Mar</div>
      <div class="calendar-day-header">Mi√©</div>
      <div class="calendar-day-header">Jue</div>
      <div class="calendar-day-header">Vie</div>
      <div class="calendar-day-header">S√°b</div>

        <div *ngFor="let calDay of calendarDays"
          class="calendar-day"
          [class.other-month]="calDay.isOtherMonth"
          [class.today]="calDay.isToday"
          [class.has-appointments]="calDay.appointments?.length > 0"
          [class.physician-appointments]="calDay.hasOwnAppointments"
          [class.clickable]="calDay.allAppointments?.length > 0"
          (click)="showDayDetails(calDay)">

        <span class="day-number">{{ calDay.day }}</span>

        <div *ngIf="calDay.appointments?.length > 0" class="appointments">
          <div *ngFor="let apt of calDay.appointments"
              class="appointment-item current-physician"
              [class.cancelled]="apt.status === 'cancelled'"
              [class.completed]="apt.status === 'completed'"
              [class.confirmed]="apt.status === 'confirmed'">

            <!-- ‚úÖ Solo citas del m√©dico actual -->
            <div class="own-appointment">
              <div class="apt-time">{{ apt.time }}</div>
              <div class="apt-patient">{{ apt.patient }}</div>
              <div class="apt-label">Mi Consulta</div>
            </div>
          </div>

          <!-- Indicador de m√°s citas -->
          <div *ngIf="calDay.hasMoreAppointments" class="more-appointments-indicator">
            <span class="more-text">
              +{{ calDay.totalAppointments - 2 }} m√°s
            </span>
            <span class="click-hint">üëÜ Click para ver todas</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Leyenda -->
    <!-- Leyenda simplificada -->
    <div class="calendar-legend">
      <h4>Leyenda:</h4>
      <div class="legend-item">
        <span class="legend-color current-physician"></span>
        <span>Mis Consultas</span>
      </div>
      <div class="legend-item">
        <span class="legend-color cancelled"></span>
        <span>Citas Canceladas</span>
      </div>
      <div class="legend-item">
        <span class="legend-color completed"></span>
        <span>Citas Completadas</span>
      </div>
      <div class="legend-item">
        <span class="legend-color confirmed"></span>
        <span>Citas Confirmadas</span>
      </div>
    </div>
  </div>
</div>