<div class="appointment-container">
  <form (ngSubmit)="submit()" class="appointment-form">
    <h2>Agendar Nueva Cita</h2>

    <div class="patient-info" *ngIf="currentUser">
      <p><strong>Paciente:</strong> {{ getPatientInfo() }}</p>
      <p><strong>ID:</strong> {{ patientId }}</p>
    </div>

    <div class="form-group">
      <label for="specialty">Especialidad:</label>
      <select
        [(ngModel)]="newAppt.specialty"
        name="specialty"
        id="specialty"
        (change)="onSpecialtyChange()"
        required
      >
        <option value="">Seleccione una especialidad</option>
        <option *ngFor="let spec of medicalSpecialties" [value]="spec.label">
          {{ spec.label }} ({{ getPhysicianCount(spec.label) }} m√©dicos)
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="physician">M√©dico:</label>
      <select
        [(ngModel)]="newAppt.physician_id"
        name="physician_id"
        id="physician"
        [disabled]="!newAppt.specialty"
        required
      >
        <option value="">
          {{
            !newAppt.specialty
              ? 'Primero seleccione una especialidad'
              : 'Seleccione un m√©dico'
          }}
        </option>
        <option *ngFor="let doc of filteredPhysicians" [value]="doc.id">
          {{ doc.fullName }}
        </option>
      </select>

      <small
        class="form-help"
        *ngIf="newAppt.specialty && filteredPhysicians.length > 0"
      >
        {{ filteredPhysicians.length }} m√©dico(s) disponible(s) en
        {{ newAppt.specialty }}
      </small>

      <small
        class="form-help error"
        *ngIf="newAppt.specialty && filteredPhysicians.length === 0"
      >
        No hay m√©dicos disponibles para esta especialidad
      </small>
    </div>

    <div class="form-group">
      <label for="date">Fecha:</label>
      <input
        type="date"
        [(ngModel)]="newAppt.date"
        name="date"
        id="date"
        required
      />
    </div>

    <div class="form-group">
      <label for="time">Hora:</label>
      <input
        type="time"
        [(ngModel)]="newAppt.time"
        name="time"
        id="time"
        required
      />
    </div>

    <div class="form-group">
      <label for="reason">üìù Motivo de la consulta:</label>
      <textarea
        [(ngModel)]="newAppt.reason"
        name="reason"
        id="reason"
        placeholder="Describa brevemente el motivo de su consulta..."
        rows="3"
        class="form-textarea"
      ></textarea>
    </div>

    <div class="form-group">
      <label for="priority">‚ö° Prioridad:</label>
      <select
        [(ngModel)]="newAppt.priority"
        name="priority"
        id="priority"
        class="form-select"
      >
        <option value="normal">Normal</option>
        <option value="high">Alta</option>
        <option value="urgent">Urgente</option>
      </select>
      <small class="form-help"
        >Seleccione "Urgente" solo en casos de emergencia</small
      >
    </div>

    <div class="form-group">
      <label for="notes">üìã Notas adicionales (opcional):</label>
      <textarea
        [(ngModel)]="newAppt.notes"
        name="notes"
        id="notes"
        placeholder="Informaci√≥n adicional que considere relevante..."
        rows="2"
        class="form-textarea"
      ></textarea>
    </div>

    <div class="form-buttons">
      <button type="submit">Agendar Cita</button>
      <button type="button" (click)="goToPatientDashboard()">Volver</button>
      <button
        type="button"
        (click)="loadAppointments()"
        style="background: #28a745"
      >
        üîÑ Recargar Citas
      </button>
    </div>
  </form>

  <!-- ‚úÖ ACTUALIZADO: Calendario solo con citas del paciente -->
  <div class="calendar-container">
    <h2>Mis Citas</h2>

    <div class="calendar-header">
      <button (click)="previousMonth()" class="nav-btn">‚ùÆ</button>
      <h3>{{ getMonthName() }}</h3>
      <button (click)="nextMonth()" class="nav-btn">‚ùØ</button>
    </div>

    <div class="calendar-grid">
      <div class="calendar-day-header">Dom</div>
      <div class="calendar-day-header">Lun</div>
      <div class="calendar-day-header">Mar</div>
      <div class="calendar-day-header">Mi√©</div>
      <div class="calendar-day-header">Jue</div>
      <div class="calendar-day-header">Vie</div>
      <div class="calendar-day-header">S√°b</div>

      <div
        *ngFor="let calDay of calendarDays"
        class="calendar-day"
        [class.other-month]="calDay.isOtherMonth"
        [class.today]="calDay.isToday"
        [class.has-appointments]="calDay.hasAppointments"
        [class.has-cancelled]="calDay.hasCancelled"
        [class.only-cancelled]="
          calDay.cancelledCount === calDay.totalAppointments &&
          calDay.totalAppointments > 0
        "
        [class.mixed-status]="calDay.hasCancelled && calDay.hasActive"
        [class.clickable]="calDay.allAppointments?.length > 0"
        (click)="showDayDetails(calDay)"
      >
        <span class="day-number">{{ calDay.day }}</span>

        <!-- ‚úÖ NUEVO: Indicador de estado -->
        <div
          *ngIf="calDay.hasAppointments"
          class="day-status-indicator"
          [class.has-cancelled]="calDay.hasCancelled && !calDay.hasActive"
          [class.has-active]="calDay.hasActive && !calDay.hasCancelled"
          [class.mixed]="calDay.hasCancelled && calDay.hasActive"
          [title]="
            calDay.activeCount +
            ' activas, ' +
            calDay.cancelledCount +
            ' canceladas'
          "
        ></div>

        <!-- ‚úÖ Citas con mejor diferenciaci√≥n de estado -->
        <div *ngIf="calDay.appointments?.length > 0" class="appointments">
          <div
            *ngFor="let apt of calDay.appointments"
            class="appointment-item"
            [class.cancelled]="apt.status === 'cancelled'"
            [class.completed]="apt.status === 'completed'"
            [class.confirmed]="apt.status === 'confirmed'"
            [class.scheduled]="apt.status === 'scheduled'"
            [class.no-show]="apt.status === 'no_show'"
          >
            <div class="apt-time">{{ apt.time }}</div>
            <div class="apt-doctor">Dr. {{ apt.physician }}</div>
            <div class="apt-status">
              {{
                apt.status === 'scheduled'
                  ? 'Programada'
                  : apt.status === 'confirmed'
                    ? 'Confirmada'
                    : apt.status === 'completed'
                      ? 'Completada'
                      : apt.status === 'cancelled'
                        ? 'CANCELADA'
                        : apt.status === 'no_show'
                          ? 'NO ASISTI√ì'
                          : 'PENDIENTE'
              }}
            </div>
          </div>

          <!-- ‚úÖ Indicador de m√°s citas con informaci√≥n de estado -->
          <div
            *ngIf="calDay.hasMoreAppointments"
            class="more-appointments-indicator"
          >
            <span class="more-text">
              +{{ calDay.totalAppointments - 3 }} m√°s
            </span>
            <span class="click-hint" *ngIf="calDay.hasCancelled">
              ({{ calDay.cancelledCount }} canceladas)
            </span>
            <span class="click-hint" *ngIf="!calDay.hasCancelled">
              üëÜ Click para ver todas
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ ACTUALIZADO: Leyenda simplificada -->
    <div class="calendar-legend">
      <h4>Leyenda de mis citas:</h4>
      <div class="legend-item">
        <span class="legend-color" style="background: #17a2b8"></span>
        <span>Citas Programadas/Confirmadas</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #28a745"></span>
        <span>Citas Completadas</span>
      </div>
      <div class="legend-item">
        <span class="legend-color cancelled"></span>
        <span>Citas Canceladas</span>
      </div>
      <!-- ‚úÖ NUEVO: Indicadores de d√≠as -->
      <div class="legend-item">
        <span
          class="legend-color"
          style="background: linear-gradient(45deg, #d4edda 50%, #f8d7da 50%)"
        ></span>
        <span>D√≠as con citas mixtas (activas y canceladas)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #f8d7da"></span>
        <span>D√≠as solo con citas canceladas</span>
      </div>
    </div>
  </div>
</div>
