<div class="appointment-container">
  <form (ngSubmit)="submit()" class="appointment-form">
    <h2>Agendar Nueva Cita</h2>

    <div class="patient-info" *ngIf="currentUser">
      <p><strong>Paciente:</strong> {{ getPatientInfo() }}</p>
      <p><strong>ID:</strong> {{ patientId }}</p>
    </div>

    <div class="form-group">
      <label for="specialty">Especialidad:</label>
      <select 
        [(ngModel)]="newAppt.specialty" 
        name="specialty" 
        id="specialty" 
        (change)="onSpecialtyChange()"
        required>
        <option value="">Seleccione una especialidad</option>
        <option *ngFor="let spec of medicalSpecialties" [value]="spec">
          {{ spec }} ({{ getPhysicianCount(spec) }} m√©dicos)
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="physician">M√©dico:</label>
      <select 
        [(ngModel)]="newAppt.physician_id" 
        name="physician_id" 
        id="physician" 
        [disabled]="!newAppt.specialty"
        required>
        <option value="">
          {{ !newAppt.specialty ? 'Primero seleccione una especialidad' : 'Seleccione un m√©dico' }}
        </option>
        <option *ngFor="let doc of filteredPhysicians" [value]="doc.id">
          {{ doc.fullName }}
        </option>
      </select>
      
      <!-- ‚úÖ Mostrar informaci√≥n adicional -->
      <small class="form-help" *ngIf="newAppt.specialty && filteredPhysicians.length > 0">
        {{ filteredPhysicians.length }} m√©dico(s) disponible(s) en {{ newAppt.specialty }}
      </small>
      
      <small class="form-help error" *ngIf="newAppt.specialty && filteredPhysicians.length === 0">
        No hay m√©dicos disponibles para esta especialidad
      </small>
    </div>

      <div class="form-group">
        <label for="date">Fecha:</label>
        <input type="date" [(ngModel)]="newAppt.date" name="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="time">Hora:</label>
        <input type="time" [(ngModel)]="newAppt.time" name="time" id="time" required>
      </div>

      <div class="form-buttons">
        <button type="submit">Agendar Cita</button>
        <button type="button" (click)="goToPatientDashboard()">Volver</button>
        <button type="button" (click)="loadAppointments()" style="background: #28a745;">üîÑ Recargar Citas</button>
      </div>
  </form>

  <div class="calendar-container">
    <h2>Mis Citas</h2>

    <div class="calendar-header">
      <button (click)="previousMonth()" class="nav-btn">‚ùÆ</button>
      <h3>{{ getMonthName() }}</h3>
      <button (click)="nextMonth()" class="nav-btn">‚ùØ</button>
    </div>

    <div class="calendar-grid">
      <div class="calendar-day-header">Dom</div>
      <div class="calendar-day-header">Lun</div>
      <div class="calendar-day-header">Mar</div>
      <div class="calendar-day-header">Mi√©</div>
      <div class="calendar-day-header">Jue</div>
      <div class="calendar-day-header">Vie</div>
      <div class="calendar-day-header">S√°b</div>

      <div *ngFor="let calDay of calendarDays"
      class="calendar-day"
      [class.other-month]="calDay.isOtherMonth"
      [class.today]="calDay.isToday"
      [class.has-appointments]="calDay.appointments?.length > 0"
      [class.mixed-appointments]="calDay.isMixedDay"
      [class.own-appointments-only]="calDay.hasOwnAppointments && !calDay.hasOtherAppointments"
      [class.other-appointments-only]="calDay.hasOtherAppointments && !calDay.hasOwnAppointments"
      [class.clickable]="calDay.allAppointments?.length > 0"
      (click)="showDayDetails(calDay)">

    <span class="day-number">{{ calDay.day }}</span>

    <div *ngIf="calDay.appointments?.length > 0" class="appointments">
      <!-- Mostrar las primeras 2 citas -->
      <div *ngFor="let apt of calDay.appointments"
          class="appointment-item"
          [class.current-patient]="apt.isCurrentPatient"
          [class.other-patient]="!apt.isCurrentPatient"
          [class.cancelled]="apt.status === 'cancelled'"
          [class.completed]="apt.status === 'completed'">

        <!-- Citas del paciente actual -->
        <div *ngIf="apt.isCurrentPatient" class="own-appointment">
          <div class="apt-time">{{ apt.time }}</div>
          <div class="apt-doctor">Dr. {{ apt.physician }}</div>
          <div class="apt-label">Mi Cita</div>
        </div>

        <!-- Citas de otros pacientes -->
        <div *ngIf="!apt.isCurrentPatient" class="other-appointment">
          <div class="apt-time">{{ apt.time }}</div>
          <div class="apt-doctor">Dr. {{ apt.physician }}</div>
          <div class="apt-patient">{{ apt.patient }}</div>
          <div class="apt-label">Ocupado</div>
        </div>
      </div>

      <!-- ‚úÖ Indicador de m√°s citas -->
      <div *ngIf="calDay.hasMoreAppointments" class="more-appointments-indicator">
        <span class="more-text">
          +{{ calDay.totalAppointments - 2 }} m√°s
        </span>
        <span class="click-hint">üëÜ Click para ver todas</span>
      </div>
    </div>
  </div>
      <div class="calendar-legend">
        <h4>Leyenda:</h4>
        <div class="legend-item">
          <span class="legend-color current-patient"></span>
          <span>Mis Citas</span>
        </div>
        <div class="legend-item">
          <span class="legend-color other-patient"></span>
          <span>Citas de Otros Pacientes</span>
        </div>
        <div class="legend-item">
          <span class="legend-color cancelled"></span>
          <span>Citas Canceladas</span>
        </div>
        <div class="legend-item">
          <span class="legend-color completed"></span>
          <span>Citas Completadas</span>
        </div>
      </div>
    </div>
  </div>
</div>
